<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Serverless Testing Page</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.149.0.min.js"></script>
    <script src="https://d2qt42rcwzspd6.cloudfront.net/manning/aws-cognito-sdk.min.js"></script>
    <script src="https://d2qt42rcwzspd6.cloudfront.net/manning/amazon-cognito-identity.min.js"></script>

    <script>
      const AWS_REGION = '{{awsRegion}}';
      const COGNITO_USER_POOL_ID = '{{cognitoUserPoolId}}';
      const CLIENT_ID = '{{cognitoClientId}}';
      const SEARCH_URL = '{{& searchUrl}}';
      var regDialog, regForm;
      var verifyDialog, verifyForm;
      var regCompleteDialog;
      var signInDialog, signInForm;
      var userPool, cognitoUser;
      var idToken;
      function toggleSignOut(enable) {
        enable === true
          ? $('#signOutButton').show()
          : $('#signOutButton').hide();
      }
      function toggleSignIn(enable) {
        enable === true ? $('#loginButton').show() : $('loginButton').hide();
      }
      function toggleRegister(enable) {
        enable === true
          ? $('#registerButton').show()
          : $('#registerButton').hide();
      }
      function init() {
        AWS.config.region = AWS_REGION;
        AWSCognito.config.region = AWS_REGION;
        var data = {
          UserPoolId: COGNITO_USER_POOL_ID,
          ClientId: CLIENT_ID,
        };
        userPool = new AWSCognito.CognitoIdentityServiceProvider.CognitoUserPool(
          data
        );
        cognitoUser = userPool.getCurrentUser();
        if (cognitoUser != null) {
          cognitoUser.getSession(function(err, session) {
            if (err) {
              alert(err);
              return;
            }
            idToken = session.idToken.jwtToken;
            console.log('idToken: ' + idToken);
            console.log('session validity: ' + session.isValid());
          });
          toggleSignOut(true);
          toggleSignIn(false);
          toggleRegister(false);
        } else {
          toggleSignOut(false);
          toggleSignIn(true);
          toggleRegister(true);
        }
      }
      function addUser() {
        var firstName = $('#registerFirstName')[0].value;
        var lastName = $('#registerLastName')[0].value;
        var username = $('#registerUserName')[0].value;
        var password = $('#registerPassword')[0].value;
        var email = $('#regitserEmail')[0].value;
        var attributeList = [
          new AWSCognito.CognitoIdentityServiceProvider.CognitoUserAttribute({
            Name: 'email',
            Value: email,
          }),
          new AWSCognito.CognitoIdentityServiceProvider.CognitoUserAttribute({
            Name: 'given_name',
            Value: firstName,
          }),
          new AWSCognito.CognitoIdentityServiceProvider.CognitoUserAttribute({
            Name: 'family_name',
            Value: lastName,
          }),
        ];
        userPool.signUp(username, password, attributeList, null, function(
          err,
          result
        ) {
          if (err) {
            alert(err);
            return;
          }
          cognitoUser = result.user;
          console.log('user name is ' + cognitoUser.getUsername());
          regDialog.modal('hide');
          verifyDialog.modal('show');
        });
      }
      function confirmUser() {
        var verificationCode = $('#verifyCode')[0].value;
        cognitoUser.confirmRegistration(verificationCode, true, function(
          err,
          result
        ) {
          if (err) {
            alert(err);
            return;
          }
          console.log('verification call result: ' + result);
          verifyDialog.modal('hide');
          regCompleteDialog.modal('show');
        });
      }
      function authenticateUser() {
        var username = $('#loginUsername')[0].value;
        var password = $('#loginPassword')[0].value;
        var authenticationData = {
          Username: username,
          Password: password,
        };
        var authenticationDetails = new AWSCognito.CognitoIdentityServiceProvider.AuthenticationDetails(
          authenticationData
        );
        var userData = {
          Username: username,
          Pool: userPool,
        };
        var cognitoUser = new AWSCognito.CognitoIdentityServiceProvider.CognitoUser(
          userData
        );
        cognitoUser.authenticateUser(authenticationDetails, {
          onSuccess: function(result) {
            console.log(
              'access token : ' + result.getAccessToken().getJwtToken()
            );
            /*Use the idToken for Logins Map when Federating User Pools with Cognito Identity or when passing through an Authorization Header to an API Gateway Authorizer*/
            idToken = result.idToken.jwtToken;
            console.log('idToken : ' + idToken);
            signInDialog.modal('hide');
            toggleRegister(false);
            toggleSignIn(false);
            toggleSignOut(true);
          },
          onFailure: function(err) {
            alert(err);
          },
        });
      }
      function signOut() {
        if (cognitoUser != null) {
          cognitoUser.signOut();
          toggleRegister(true);
          toggleSignIn(true);
          toggleSignOut(false);
        }
      }
      function searchRestaurants() {
        var theme = $('#theme')[0].value;
        var xhr = new XMLHttpRequest();
        xhr.open('POST', SEARCH_URL, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('Authorization', idToken);
        xhr.send(JSON.stringify({ theme }));

        xhr.onreadystatechange = function(e) {
          if (xhr.readyState === 4 && xhr.status === 200) {
            var restaurants = JSON.parse(xhr.responseText);
            var restaurantsList = $('#restaurantsUl');
            restaurantsList.empty();
            for (var restaurant of restaurants) {
              restaurantsList.append(`
                <div class="col-md-4">
                    <div class="card mb-4 box-shadow">
                        <img class="card-img-top" src="${restaurant.image}">
                        <div class="card-body">
                                ${restaurant.name}
                        </div>
                    </div>
                </div>
                `);
            }
          } else if (xhr.readyState === 4) {
            alert(xhr.responseText);
          }
        };
      }
      $(document).ready(function() {
        regDialog = $('#registerModal');
        regForm = regDialog.find('form').on('submit', function(event) {
          event.preventDefault();
          addUser();
        });

        verifyDialog = $('#verifyModal');
        verifyForm = verifyDialog.find('form').on('submit', function(event) {
          event.preventDefault();
          confirmUser();
        });

        regCompleteDialog = $('#registerCompleteModal');

        signInDialog = $('#loginModal');
        signInForm = signInDialog.find('form').on('submit', function(event) {
          event.preventDefault();
          authenticateUser();
        });
        init();
      });
    </script>
  </head>

  <body>
    <header>
      <div class="navbar narbar-dark bg-dark box-shadow">
        <div class="container">
          <a href="#" class="navbar-brand">Serverless Test Site</a>
          <nav class="my-2 my-md-0 mr-md-3">
            <input
              type="text"
              placeholder="Search"
              class="form-control"
              id="theme"
            />
            <button
              class="p-2 btn btn-primary"
              type="button"
              onclick="searchRestaurants()"
            >
              Search
            </button>
            <button
              id="registerButton"
              class="p-2 btn btn-primary hidden"
              type="button"
              data-toggle="modal"
              data-target="#registerModal"
            >
              Register
            </button>
            <button
              id="loginButton"
              class="p-2 btn btn-primary hidden"
              type="button"
              data-toggle="modal"
              data-target="#loginModal"
            >
              Sign In
            </button>
            <button
              id="signOutButton"
              class="p-2 btn btn-danger hidden"
              onclick="signOut()"
            >
              Sign Out
            </button>
          </nav>
        </div>
      </div>
    </header>
    <main role="main">
      <section class="jumbotron">
        <div class="container">
          <div class="row" id="restaurantsUl">
            {{#restaurants}}
            <div class="col-md-4">
              <div class="card mb-4 box-shadow">
                <img class="card-img-top" src="{{ image }}" />
                <div class="card-body">
                  {{ name }}
                </div>
              </div>
            </div>
            {{/restaurants}}
          </div>
        </div>
      </section>
    </main>
    <div
      class="modal fade"
      id="loginModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="Sign In"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <form>
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLongTitle">Sign In</h5>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label for="loginUsername">Username</label>
                <input
                  type="text"
                  class="form-control"
                  id="loginUsername"
                  placeholder="John123"
                />
              </div>
              <div class="form-group">
                <label for="loginPassword">Password</label>
                <input
                  type="password"
                  class="form-control"
                  id="loginPassword"
                  placeholder="Password"
                />
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Close
              </button>
              <button type="submit" class="btn btn-primary">Sign In</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    <div
      class="modal fade"
      id="registerModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="Register"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <form>
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="register">Register</h5>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label for="registerFirstName">First Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="registerFirstName"
                  placeholder="John"
                />
              </div>
              <div class="form-group">
                <label for="registerLastName">Last Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="registerLastName"
                  placeholder="Pattrick"
                />
              </div>
              <div class="form-group">
                <label for="regitserEmail">Email Address</label>
                <input
                  type="email"
                  class="form-control"
                  id="regitserEmail"
                  aria-describedby="emailRegisterHelp"
                  placeholder="john@example.com"
                />
                <small id="emailRegisterHelp" class="form-text text-muted"
                  >We'll never share your email with anyone else.</small
                >
              </div>
              <div class="form-group">
                <label for="registerUserName">Username</label>
                <input
                  type="text"
                  class="form-control"
                  id="registerUserName"
                  placeholder="John123"
                />
              </div>
              <div class="form-group">
                <label for="registerPassword">Password</label>
                <input
                  type="password"
                  class="form-control"
                  id="registerPassword"
                  placeholder="Password"
                />
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Close
              </button>
              <button type="submit" class="btn btn-primary">Register</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    <div
      class="modal fade"
      id="registerCompleteModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="Registation Complete"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="registerComplete">Register Complete</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p>Registration is now completed, continue to use the website</p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
    <div
      class="modal fade"
      id="verifyModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="Verify Account"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <form>
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="verify">Register</h5>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label for="verifyCode">Verification Code</label>
                <input
                  type="text"
                  class="form-control"
                  id="verifyCode"
                  placeholder="123456"
                />
              </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">Verify</button>
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Close
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </body>
</html>
